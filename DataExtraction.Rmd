---
title: "R Notebook"
output: html_notebook
---

### Loading Packages
```{r}
library(dplyr)
```


```{r}
cbbdata::cbd_login(username = "Naki", password = "Duke@123")
```

```{r}
data <- cbbdata::cbd_torvik_game_stats(year = 2025)

all_teams <- unique(data$team) # There are 364 teams in total
total_na <- colSums(is.na(data)) 
```

## Testing Date
```{r}
current_date <- as.Date("2024-12-27")
```


## Creating Train Data

```{r}
filtered_data <- data |> 
  filter(date != current_date)

train_data <- filtered_data |>
  group_by(game_id, date) |>
  summarize(
    Team = first(team),
    Opponent = last(team),
    Team_Score = first(pts_scored),
    Opponent_Score = first(pts_allowed),
    Location = first(location),
    
    ADJO = first(adj_o),
    ADJD = first(adj_d),
    EFF = first(off_ppp),
    EFG_pct = first(off_efg),
    TO_Pct = first(off_to),
    OR_Pct = first(off_or),
    FTR_Pct = first(off_ftr),
    ThreePointer_Pct = round((first(tp_pct*100)), 2),

    opp_ADJO = last(adj_o),
    opp_ADJD = last(adj_d),
    Opp_EFF = last(off_ppp),
    Opp_EFG_Pct = last(off_efg),
    Opp_TO_Pct = last(off_to),
    Opp_OR_Pct = last(off_or),
    Opp_FTR_Pct = last(off_ftr),
    Opp_ThreePointer_Pct = round((last(tp_pct*100)), 2),
    
    .groups = "drop" # Remove grouping
  )

train_data$Location[is.na(train_data$Location)] <- "N" 
```


## Creating Test Data

```{r}
date_required <- data |> 
  filter(date == current_date)

# Combine rows for each game
test_data <- date_required |>
  group_by(game_id, date) |>
  summarize(
    Team = first(team),
    Opponent = last(team),
    Team_Score = first(pts_scored),
    Opponent_Score = first(pts_allowed),
    Location = first(location),
    
    ADJO = first(adj_o),
    ADJD = first(adj_d),
    EFF = first(off_ppp),
    EFG_pct = first(off_efg),
    TO_Pct = first(off_to),
    OR_Pct = first(off_or),
    FTR_Pct = first(off_ftr),
    ThreePointer_Pct = round((first(tp_pct*100)), 2),

    opp_ADJO = last(adj_o),
    opp_ADJD = last(adj_d),
    Opp_EFF = last(off_ppp),
    Opp_EFG_Pct = last(off_efg),
    Opp_TO_Pct = last(off_to),
    Opp_OR_Pct = last(off_or),
    Opp_FTR_Pct = last(off_ftr),
    Opp_ThreePointer_Pct = round((last(tp_pct*100)), 2),

    .groups = "drop" # Remove grouping
  )

test_data$Location[is.na(test_data$Location)] <- "N" 
```

```{r}
train_file <- "train_data.csv"
test_file <- "test_data.csv"
```


```{r}
write.csv(train_data, train_file, row.names = FALSE)
write.csv(test_data, test_file, row.names = FALSE)
```


